{% extends 'base.html' %}
{% block content %}

{% csrf_token %}
<div id="fullscreen-blocker" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 1050; display: flex; justify-content: center; align-items: center; flex-direction: column;">
    <h2 class="mb-4">Listo para comenzar</h2>
    <p class="lead mb-4">Haz clic en el botón de abajo para entrar en modo de pantalla completa.</p>
    <button id="start-fullscreen-btn" class="btn btn-primary btn-lg">Comenzar Examen en Pantalla Completa</button>
</div>
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-7">
            
            <h2 class="text-center mb-4">Examen de entrada CPTD</h2>


            <div id="alerta-pregunta" class="alert alert-warning alert-dismissible fade show d-none" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i> 
                <strong>Atención:</strong> Debes marcar una alternativa para continuar.
                <button type="button" class="btn-close" onclick="cerrarAlerta()"></button>
            </div>

            {# 1. Bucle Principal: Itera sobre cada PREGUNTA #}
            {% for pregunta in preguntas %}
            <div class="card question-card 
                {# 2. Ocultamos todas las tarjetas MENOS la primera #}
                {% if not forloop.first %}d-none{% endif %}
            ">
                <div class="card-body p-4">
                    <h5 class="card-title">Pregunta {{ forloop.counter }}</h5>
                    <p class="card-text fs-5">
                        {{ pregunta.texto_pregunta }}
                    </p>
                    {% for alternativa in pregunta.alternativasexamen_set.all %}
                    <div class="form-check">
                        <input class="form-check-input" 
                               type="radio" 
                               name="pregunta-{{ pregunta.id_preguntas_examen }}" 
                               id="alt-{{ alternativa.id_alternativas_examen }}">
                        <label class="form-check-label" for="alt-{{ alternativa.id_alternativas_examen }}">
                            {{ alternativa.texto_alternativa }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            <div class="card question-card d-none">
                <div class="card-body p-5 text-center">
                    <h5 class="card-title fs-2">¡Examen completado!</h5>
                    <p class="card-text fs-5">
                        Has respondido todas las preguntas.
                    </p>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button class="btn btn-primary btn-lg" id="next-btn" onclick="mostrarSiguiente()">
                    Siguiente
                </button>
            </div>

        </div>
    </div>
</div>

<style>
    /* ... (Tu style no cambia) ... */
</style>



<script>
    let currentQuestionIndex = 0;
    const questions = document.querySelectorAll('.question-card');
    const nextButton = document.getElementById('next-btn');
    const examenId = {{ examen_id|default:"null" }};

    // --- (Lógica de pantalla completa se queda igual) ---
    const fullscreenBlocker = document.getElementById('fullscreen-blocker');
    const startFullscreenButton = document.getElementById('start-fullscreen-btn');
    startFullscreenButton.addEventListener('click', function() {
        document.documentElement.requestFullscreen().then(() => {
            fullscreenBlocker.style.display = 'none';
        }).catch(err => {
            alert('Error al entrar en pantalla completa. Por favor, permítelo para continuar.');
        });
    });

    // --- (Funciones getCookie y collectAnswers se quedan igual) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function collectAnswers() {
        const answers = [];
        const checkedInputs = document.querySelectorAll('input[type="radio"]:checked');
        checkedInputs.forEach(input => {
            answers.push({
                pregunta: input.name.split('-')[1],
                alternativa: input.id.split('-')[1]
            });
        });
        return answers;
    }

    // --- ¡FUNCIÓN 'mostrarSiguiente' MODIFICADA! ---
    function mostrarSiguiente() {
        const currentCard = questions[currentQuestionIndex];
        const isChecked = currentCard.querySelector('input[type="radio"]:checked');
        const alertBox = document.getElementById('alerta-pregunta');

        // 1. VALIDACIÓN SUAVE (Sin alert() nativo)
        if (!isChecked) {
            // En lugar de alert(), mostramos la caja HTML
            alertBox.classList.remove('d-none'); 
            
            // Opcional: Un pequeño efecto de vibración o scroll para que lo note
            alertBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return; // Detiene la función aquí
        }

        // 2. Si pasó la validación, ocultamos la alerta por si estaba abierta
        alertBox.classList.add('d-none');

        // 2. Si pasó la validación, procedemos a avanzar
        currentCard.classList.add('d-none');
        currentQuestionIndex++;

        
        if (currentQuestionIndex < questions.length) {
            questions[currentQuestionIndex].classList.remove('d-none');
        }




        if (currentQuestionIndex === questions.length - 2) {
            nextButton.textContent = 'Finalizar';
        }
        
        // --- ¡LÓGICA DE FINALIZACIÓN MODIFICADA! ---
        if (currentQuestionIndex === questions.length - 1) {
            questions[currentQuestionIndex].classList.remove('d-none');
            nextButton.textContent = 'Enviar y Volver al Panel';
            nextButton.classList.remove('d-none');
            
            nextButton.onclick = async function() {
                nextButton.disabled = true;
                nextButton.textContent = 'Enviando...';
                const respuestas = collectAnswers();
                const csrftoken = getCookie('csrftoken');

                if (!csrftoken) {
                    alert('Error de seguridad (CSRF). Por favor, refresca la página e inténtalo de nuevo.');
                    nextButton.disabled = false;
                    nextButton.textContent = 'Enviar y Volver al Panel';
                    return;
                }

                try {
                    // 1. Enviar respuestas a Django
                    const response = await fetch("{% url 'submit_exam' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            examen_id: examenId,
                            respuestas: respuestas
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Error al guardar las respuestas.');
                    }

                    // --- INICIO DE LA SOLUCIÓN ROBUSTA ---
                    
                    // A. Preparamos una Promesa que espere la CONFIRMACIÓN de la extensión
                    const esperarConfirmacionExtension = new Promise((resolve) => {
                        const manejadorMensaje = (event) => {
                            // Solo escuchamos la confirmación específica
                            if (event.source === window && event.data && event.data.type === 'EXTENSION_ACK_FINISHED') {
                                window.removeEventListener('message', manejadorMensaje); // Limpieza
                                resolve(); // ¡Ya es seguro!
                            }
                        };
                        window.addEventListener('message', manejadorMensaje);
                    });

                    // B. Enviamos la señal a la extensión
                    window.postMessage({ type: 'FROM_PAGE_EXAM_FINISHED' }, '*');
                    
                    // C. Esperamos (await) a que la extensión responda "OK"
                    // Esto garantiza que isFinishingExam = true ya está guardado.
                    await esperarConfirmacionExtension;

                    // --- FIN DE LA SOLUCIÓN ROBUSTA ---
                    
                    // 4. Sale de pantalla completa (AHORA ES 100% SEGURO)
                    if (document.fullscreenElement) {
                        await document.exitFullscreen();
                    }

                    // 5. Redirige al dashboard
                    window.location.href = "{% url 'exam_dashboard' %}";

                } catch (e) {
                    console.error('Error al finalizar el examen:', e);
                    alert('Error al enviar tus respuestas: ' + e.message);
                    nextButton.disabled = false;
                    nextButton.textContent = 'Enviar y Volver al Panel';
                }
            };
        }
    }




</script>

{% endblock %}